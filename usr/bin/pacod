#!/bin/bash
# pacod - Optional dependency helper for pacman
# Copyright (c) 2026 Elppans
# Licensed under the MIT License.
# See LICENSE file for details.

VERSION="1.0.0"
CMD="$(basename "$0")"

# Cores
bold=$(tput bold)
reset=$(tput sgr0)
blue=$(tput setaf 4)
red=$(tput setaf 1)
# Detecta idioma
LANG_CHECK="${LC_MESSAGES:-${LANG}}"

if [[ "$LANG_CHECK" == pt* ]]; then
	IDIOMA="pt"
else
	IDIOMA="en"
fi
export IDIOMA

if [[ "$IDIOMA" == "pt" ]]; then
	MSG_DESC="Lista dependências opcionais (optdepends) de pacotes e grupos do Arch Linux"
	MSG_USO="USO:"
	MSG_ERRO_ARGS="Erro: argumentos insuficientes."
	MSG_INVALIDO="Opção inválida."
	MSG_NAO_ENCONTRADO="Não é pacote nem grupo:"
else
	MSG_DESC="Lists optional dependencies (optdepends) of Arch Linux packages and groups"
	MSG_USO="USAGE:"
	MSG_ERRO_ARGS="Error: insufficient arguments."
	MSG_INVALIDO="Invalid option."
	MSG_NAO_ENCONTRADO="Not a package or group:"
fi

export MSG_DESC
export MSG_USO
export MSG_ERRO_ARGS
export MSG_INVALIDO
export MSG_NAO_ENCONTRADO

# Verifica se pacote existe
pacote_existe() {
	pacman -Si "$1" &>/dev/null
}

# Verifica se pacote é tipo grupo
eh_grupo() {
	pacman -Sgq "$1" &>/dev/null
}

# Coleta optdepends (apenas nomes)
coletar_optdeps() {
	for item in "$@"; do
		if eh_grupo "$item"; then
			expac -S -g "%o" "$item" -l "\n" 2>/dev/null
		else
			expac -S "%o" "$item" -l "\n" 2>/dev/null
		fi
	done | awk 'NF'
}

# Coleta optdepends com descrição
coletar_optdeps_desc() {
	for item in "$@"; do
		if eh_grupo "$item"; then
			expac -S -g "%o: %d" "$item" -l "\n" 2>/dev/null
		else
			expac -S "%o: %d" "$item" -l "\n" 2>/dev/null
		fi
	done | awk 'NF'
}

exibir_lista() {
	coletar_optdeps "${pacotes[@]}" | sort -u
}

exibir_coluna() {
	coletar_optdeps "${pacotes[@]}" | sort -u | paste -sd ' ' -
	echo
}

exibir_com_descricao() {
	for item in "${pacotes[@]}"; do

		if eh_grupo "$item"; then
			echo "${bold}${blue}$item (grupo):${reset}"

			declare -A mapa
			declare -A descricao

			# Itera sobre cada pacote do grupo
			while read -r pkg; do
				# Pega optdepends do pacote
				while read -r opt; do
					nome="${opt%%:*}"  # antes dos dois pontos
					nome="${nome%% *}" # remove espaços extras
					desc="${opt#*:}"   # depois dos dois pontos

					# remove espaços extras no começo
					desc="${desc#"${desc%%[![:space:]]*}"}"

					[[ -z "$nome" ]] && continue

					# salva descrição (uma vez só)
					if [[ -z "${descricao[$nome]}" && -n "$desc" ]]; then
						descricao["$nome"]="$desc"
					fi
					mapa["$nome"]+="$pkg "
				done < <(expac -S "%o: %d" "$pkg" -l "\n" 2>/dev/null)

			done < <(pacman -Sgq "$item")

			# imprime organizado
			printf "%s\n" "${!mapa[@]}" | sort | while IFS= read -r opt; do
				desc="${descricao[$opt]}"

				# imprime nome + descrição apenas se válida
				if [[ -z "$desc" || "$desc" == "$opt" ]]; then
					printf "%s\n" "$opt"
				else
					printf "%s: %s\n" "$opt" "$desc"
				fi

				# prepara lista de dependentes ordenada e única
				mapfile -t pkgs < <(printf "%s\n" "${mapa[$opt]}" | tr ' ' '\n' | sort -u)

				total=${#pkgs[@]}

				for ((i = 0; i < total; i++)); do
					[[ -z "${pkgs[i]}" ]] && continue

					if ((i == total - 1)); then
						printf "  └─ %s\n" "${pkgs[i]}"
					else
						printf "  ├─ %s\n" "${pkgs[i]}"
					fi
				done

				echo
			done

			unset mapa descricao

		elif pacote_existe "$item"; then
			echo "${bold}${blue}$item:${reset}"
			expac -S "%o: %d" "$item" -l "\n" 2>/dev/null | awk 'NF'
			echo
		else
			echo "${red}$MSG_NAO_ENCONTRADO:${reset} $item"
		fi

	done
}

mostrar_help() {

	if [[ "$IDIOMA" == "pt" ]]; then

		cat <<EOF
$CMD - $MSG_DESC

$MSG_USO
	$CMD [opção] <pacote|grupo> [...]

DESCRIÇÃO:
	Exibe as dependências opcionais (optdepends) de pacotes individuais
	ou de todos os pacotes pertencentes a um grupo.

OPÇÕES:
	-l    Lista simples (uma por linha, sem descrição)
	-c    Lista em coluna única (separadas por espaço)
	-d    Exibe com descrição.
        Para grupos, mostra também quais pacotes utilizam cada optdepend.
	-h    Mostra esta ajuda e sai

EXEMPLOS:
	$CMD -l lutris
	$CMD -d gnome
	$CMD -c firefox thunderbird
	$CMD -d lutris gnome

	# Instalar um pacote junto com todas as suas dependências opcionais:
	pacman --needed -S lutris \$($CMD -c lutris)

	# Instalar múltiplos pacotes junto com seus optdepends:
	pacman --needed -S lutris \$($CMD -c lutris wine)

OBS:
	Para grupos, a saída é organizada em formato de árvore,
	indicando quais pacotes utilizam cada dependência opcional.

EOF

	else

		cat <<EOF
$CMD - $MSG_DESC

$MSG_USO
  $CMD [option] <package|group> [...]

DESCRIPTION:
  Displays optional dependencies (optdepends) for individual packages
  or for all packages belonging to a group.

OPTIONS:
  -l    Simple list (one per line, no description)
  -c    Single line output (space-separated)
  -d    Show with description.
        For groups, also displays which packages use each optdepend.
  -h    Show this help and exit

EXAMPLES:
  $CMD -l lutris
  $CMD -d gnome
  $CMD -c firefox thunderbird
  $CMD -d lutris gnome

  # Install a package along with all its optional dependencies:
  pacman --needed -S lutris \$($CMD -c lutris)

  # Install multiple packages along with their optdepends:
  pacman --needed -S lutris \$($CMD -c lutris wine)

NOTES:
  For groups, the output is organized in a tree format,
  indicating which packages use each optional dependency.

EOF

	fi
}

# =============================
# Argumentos
# =============================
if [[ "$1" == "-v" || "$1" == "--version" ]]; then
	echo "$CMD version $VERSION"
	exit 0
fi

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	mostrar_help
	exit 0
fi

if [[ $# -lt 1 ]]; then
	mostrar_help
	exit 1
fi

if [[ $# -lt 2 ]]; then
	echo "$MSG_ERRO_ARGS"
	echo
	mostrar_help
	exit 1
fi

opcao="$1"
shift
pacotes=("$@")

case "$opcao" in
-l)
	exibir_lista
	;;
-c)
	exibir_coluna
	;;
-d)
	exibir_com_descricao
	;;
*)
	echo "$MSG_INVALIDO"
	exit 1
	;;
esac
